<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SERPENT Connectivity Dashboard - {{ role|upper }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">SERPENT Connectivity Dashboard - {{ role|upper }}</span>
            <div class="d-flex">
                <a href="/" class="btn btn-outline-light btn-sm me-2">Dashboard</a>
                <a href="/logs" class="btn btn-outline-light btn-sm me-2">Logs</a>
                <a href="/diagnostics" class="btn btn-outline-light btn-sm">Diagnostics</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-3">

        <!-- E-STOP Banner (UNCHANGED - safety critical) -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card" id="estop-card">
                    <div class="card-body">
                        <h5 class="card-title">E-STOP Status</h5>
                        <div id="estop-status" class="estop-indicator">
                            <span id="estop-engaged" class="badge bg-success">Cleared</span>
                            <span id="estop-reason" class="ms-2"></span>
                            <span id="estop-age" class="ms-2 text-muted"></span>
                        </div>
                        {% if role == 'robot_pi' %}
                        <div class="mt-3">
                            <button id="btn-estop-clear" class="btn btn-success btn-sm me-2" onclick="clearEstop()">Clear E-STOP</button>
                            <button id="btn-estop-engage" class="btn btn-danger btn-sm" onclick="engageEstop()">Emergency Stop</button>
                            <small class="text-muted d-block mt-2">Ensure all safety checks are complete before clearing E-STOP</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Overall Status Banner -->
        <div id="overall-status" class="overall-status down">Waiting for data...</div>

        <!-- Data Flow Overview + Link Health -->
        <div class="row mb-3">
            <!-- Data Flow Diagram -->
            <div class="col-lg-9 mb-3">
                <div class="data-flow-overview">
                    <h6 class="mb-3">Data Flow</h6>

                    {% if role == 'robot_pi' %}
                    <!-- Robot Pi perspective: receives control, sends telemetry + video -->
                    <div class="data-flow-row">
                        <span class="data-flow-node">Base Pi</span>
                        <span class="data-flow-arrow">&rarr;</span>
                        <span id="df-control" class="data-flow-channel unknown">Control</span>
                        <span class="data-flow-arrow">&rarr;</span>
                        <span class="data-flow-node self">Robot Pi</span>
                    </div>
                    <div class="data-flow-row">
                        <span class="data-flow-node self">Robot Pi</span>
                        <span class="data-flow-arrow">&rarr;</span>
                        <span id="df-telemetry" class="data-flow-channel unknown">Telemetry</span>
                        <span class="data-flow-arrow">&rarr;</span>
                        <span class="data-flow-node">Base Pi</span>
                    </div>
                    <div class="data-flow-row">
                        <span class="data-flow-node self">Robot Pi</span>
                        <span class="data-flow-arrow">&rarr;</span>
                        <span id="df-video" class="data-flow-channel unknown">Video</span>
                        <span class="data-flow-arrow">&rarr;</span>
                        <span class="data-flow-node">Base Pi</span>
                    </div>
                    {% else %}
                    <!-- Base Pi perspective: sends control, receives telemetry + video -->
                    <div class="data-flow-row">
                        <span class="data-flow-node self">Base Pi</span>
                        <span class="data-flow-arrow">&rarr;</span>
                        <span id="df-control" class="data-flow-channel unknown">Control</span>
                        <span class="data-flow-arrow">&rarr;</span>
                        <span class="data-flow-node">Robot Pi</span>
                    </div>
                    <div class="data-flow-row">
                        <span class="data-flow-node">Robot Pi</span>
                        <span class="data-flow-arrow">&rarr;</span>
                        <span id="df-telemetry" class="data-flow-channel unknown">Telemetry</span>
                        <span class="data-flow-arrow">&rarr;</span>
                        <span class="data-flow-node self">Base Pi</span>
                    </div>
                    <div class="data-flow-row">
                        <span class="data-flow-node">Robot Pi</span>
                        <span class="data-flow-arrow">&rarr;</span>
                        <span id="df-video" class="data-flow-channel unknown">Video</span>
                        <span class="data-flow-arrow">&rarr;</span>
                        <span class="data-flow-node self">Base Pi</span>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Link Health Sidebar -->
            <div class="col-lg-3 mb-3">
                <div class="card h-100">
                    <div class="card-body link-health">
                        <h6 class="card-title">Link Health</h6>
                        <div class="health-item">
                            <span>PSK Valid</span>
                            <span id="health-psk" class="fw-bold">--</span>
                        </div>
                        <div class="health-item">
                            <span>Uptime</span>
                            <span id="health-uptime" class="fw-bold monospace">--</span>
                        </div>
                        <div class="health-item">
                            <span>Last Update</span>
                            <span id="health-timestamp" class="fw-bold monospace">--</span>
                        </div>
                        <div class="health-item">
                            <span>Watchdog</span>
                            <span id="health-watchdog" class="fw-bold">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Channel Detail Cards -->
        <div class="row mb-3">
            <!-- Control Channel -->
            <div class="col-md-4 mb-3">
                <div id="card-control" class="channel-card unknown">
                    <div class="channel-title">
                        Control
                        <span id="badge-control" class="state-badge unknown">unknown</span>
                    </div>
                    <div class="channel-metric">
                        <span class="metric-label">State</span>
                        <span id="ctrl-state" class="metric-value">--</span>
                    </div>
                    {% if role == 'robot_pi' %}
                    <div class="channel-metric">
                        <span class="metric-label">Established</span>
                        <span id="ctrl-established" class="metric-value">--</span>
                    </div>
                    <div class="channel-metric">
                        <span class="metric-label">Command Age</span>
                        <span id="ctrl-age" class="metric-value">--</span>
                    </div>
                    <div class="channel-metric">
                        <span class="metric-label">Sequence #</span>
                        <span id="ctrl-seq" class="metric-value">--</span>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Telemetry Channel -->
            <div class="col-md-4 mb-3">
                <div id="card-telemetry" class="channel-card unknown">
                    <div class="channel-title">
                        Telemetry
                        <span id="badge-telemetry" class="state-badge unknown">unknown</span>
                    </div>
                    <div class="channel-metric">
                        <span class="metric-label">State</span>
                        <span id="telem-state" class="metric-value">--</span>
                    </div>
                    {% if role == 'base_pi' %}
                    <div class="channel-metric">
                        <span class="metric-label">RTT</span>
                        <span id="telem-rtt" class="metric-value">--</span>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Video Channel -->
            <div class="col-md-4 mb-3">
                <div id="card-video" class="channel-card unknown">
                    <div class="channel-title">
                        Video
                        <span id="badge-video" class="state-badge unknown">unknown</span>
                    </div>
                    <div class="channel-metric">
                        <span class="metric-label">State</span>
                        <span id="video-state" class="metric-value">--</span>
                    </div>
                    {% if role == 'robot_pi' %}
                    <div class="channel-metric">
                        <span class="metric-label">Frames Sent</span>
                        <span id="video-frames-sent" class="metric-value">--</span>
                    </div>
                    <div class="channel-metric">
                        <span class="metric-label">Frames Dropped</span>
                        <span id="video-frames-dropped" class="metric-value">--</span>
                    </div>
                    <div class="channel-metric">
                        <span class="metric-label">Drop Rate</span>
                        <span id="video-drop-rate" class="metric-value">--</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Controller Input Display (Base Pi only) -->
        {% if role == 'base_pi' %}
        <div class="row mb-3">
            <div class="col-12">
                <div class="accordion" id="controllerAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#controllerBody">
                                ðŸŽ® Controller Input (TrimUI)
                            </button>
                        </h2>
                        <div id="controllerBody" class="accordion-collapse collapse" data-bs-parent="#controllerAccordion">
                            <div class="accordion-body">
                                <p class="text-muted small mb-3">Real-time button press visualization from TrimUI controller</p>

                                <!-- Face Buttons -->
                                <div class="controller-section mb-4">
                                    <h6>Face Buttons</h6>
                                    <div class="button-grid">
                                        <div class="controller-button" id="btn-0" data-index="0">
                                            <span class="button-label">A (0)</span>
                                            <span class="button-function">Claw Open</span>
                                        </div>
                                        <div class="controller-button" id="btn-1" data-index="1">
                                            <span class="button-label">B (1)</span>
                                            <span class="button-function">Claw Close</span>
                                        </div>
                                        <div class="controller-button" id="btn-2" data-index="2">
                                            <span class="button-label">X (2)</span>
                                            <span class="button-function">Available</span>
                                        </div>
                                        <div class="controller-button" id="btn-3" data-index="3">
                                            <span class="button-label">Y (3)</span>
                                            <span class="button-function">E-STOP</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Shoulder Buttons -->
                                <div class="controller-section mb-4">
                                    <h6>Shoulder Buttons</h6>
                                    <div class="button-grid">
                                        <div class="controller-button" id="btn-4" data-index="4">
                                            <span class="button-label">L1 (4)</span>
                                            <span class="button-function">Camera Prev</span>
                                        </div>
                                        <div class="controller-button" id="btn-5" data-index="5">
                                            <span class="button-label">R1 (5)</span>
                                            <span class="button-function">Camera Next</span>
                                        </div>
                                        <div class="controller-button" id="btn-6" data-index="6">
                                            <span class="button-label">L2 (6)</span>
                                            <span class="button-function">Chainsaw 1 On/Off</span>
                                        </div>
                                        <div class="controller-button" id="btn-7" data-index="7">
                                            <span class="button-label">R2 (7)</span>
                                            <span class="button-function">Chainsaw 2 On/Off</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- System Buttons -->
                                <div class="controller-section mb-4">
                                    <h6>System Buttons</h6>
                                    <div class="button-grid">
                                        <div class="controller-button" id="btn-8" data-index="8">
                                            <span class="button-label">SELECT (8)</span>
                                            <span class="button-function">Dashboard</span>
                                        </div>
                                        <div class="controller-button" id="btn-9" data-index="9">
                                            <span class="button-label">START (9)</span>
                                            <span class="button-function">Menu</span>
                                        </div>
                                        <div class="controller-button" id="btn-14" data-index="14">
                                            <span class="button-label">L3 (14)</span>
                                            <span class="button-function">Available</span>
                                        </div>
                                        <div class="controller-button" id="btn-15" data-index="15">
                                            <span class="button-label">R3 (15)</span>
                                            <span class="button-function">Available</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- D-Pad -->
                                <div class="controller-section mb-4">
                                    <h6>D-Pad</h6>
                                    <div class="button-grid">
                                        <div class="controller-button" id="btn-10" data-index="10">
                                            <span class="button-label">Up (10)</span>
                                            <span class="button-function">Climb Up</span>
                                        </div>
                                        <div class="controller-button" id="btn-11" data-index="11">
                                            <span class="button-label">Down (11)</span>
                                            <span class="button-function">Climb Down</span>
                                        </div>
                                        <div class="controller-button" id="btn-12" data-index="12">
                                            <span class="button-label">Left (12)</span>
                                            <span class="button-function">Traverse Left</span>
                                        </div>
                                        <div class="controller-button" id="btn-13" data-index="13">
                                            <span class="button-label">Right (13)</span>
                                            <span class="button-function">Traverse Right</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Left Stick -->
                                <div class="controller-section mb-4">
                                    <h6>Left Stick (Chainsaw 1)</h6>
                                    <div class="button-grid">
                                        <div class="controller-button" id="btn-16" data-index="16">
                                            <span class="button-label">Up (16)</span>
                                            <span class="button-function">Chainsaw 1 Up</span>
                                        </div>
                                        <div class="controller-button" id="btn-17" data-index="17">
                                            <span class="button-label">Down (17)</span>
                                            <span class="button-function">Chainsaw 1 Down</span>
                                        </div>
                                        <div class="controller-button" id="btn-18" data-index="18">
                                            <span class="button-label">Left (18)</span>
                                            <span class="button-function">Available</span>
                                        </div>
                                        <div class="controller-button" id="btn-19" data-index="19">
                                            <span class="button-label">Right (19)</span>
                                            <span class="button-function">Available</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Right Stick -->
                                <div class="controller-section mb-4">
                                    <h6>Right Stick (Chainsaw 2)</h6>
                                    <div class="button-grid">
                                        <div class="controller-button" id="btn-20" data-index="20">
                                            <span class="button-label">Up (20)</span>
                                            <span class="button-function">Chainsaw 2 Up</span>
                                        </div>
                                        <div class="controller-button" id="btn-21" data-index="21">
                                            <span class="button-label">Down (21)</span>
                                            <span class="button-function">Chainsaw 2 Down</span>
                                        </div>
                                        <div class="controller-button" id="btn-22" data-index="22">
                                            <span class="button-label">Left (22)</span>
                                            <span class="button-function">Available</span>
                                        </div>
                                        <div class="controller-button" id="btn-23" data-index="23">
                                            <span class="button-label">Right (23)</span>
                                            <span class="button-function">Available</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="alert alert-info mt-3" role="alert">
                                    <small><strong>Live Input:</strong> Buttons will highlight in green when pressed. This shows real-time input from the TrimUI controller.</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Sensors (collapsed accordion) -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="accordion sensors-accordion" id="sensorsAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sensorBody">
                                Sensors
                            </button>
                        </h2>
                        <div id="sensorBody" class="accordion-collapse collapse" data-bs-parent="#sensorsAccordion">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>IMU</h6>
                                        <small>
                                            <strong>Accel:</strong> X: <span id="imu-ax">--</span>, Y: <span id="imu-ay">--</span>, Z: <span id="imu-az">--</span><br>
                                            <strong>Gyro:</strong> X: <span id="imu-gx">--</span>, Y: <span id="imu-gy">--</span>, Z: <span id="imu-gz">--</span><br>
                                            <strong>Quat:</strong> W: <span id="imu-qw">--</span>, X: <span id="imu-qx">--</span>, Y: <span id="imu-qy">--</span>, Z: <span id="imu-qz">--</span>
                                        </small>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Barometer</h6>
                                        <small>
                                            <strong>Pressure:</strong> <span id="baro-pressure">--</span> Pa<br>
                                            <strong>Temperature:</strong> <span id="baro-temp">--</span> &deg;C<br>
                                            <strong>Altitude:</strong> <span id="baro-alt">--</span> m
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Motor Currents (collapsed accordion) -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="accordion motors-accordion" id="motorsAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#motorsBody">
                                Motor Currents
                            </button>
                        </h2>
                        <div id="motorsBody" class="accordion-collapse collapse" data-bs-parent="#motorsAccordion">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        {% for i in range(4) %}
                                        <div class="motor-current-item mb-2">
                                            <strong>Motor {{ i }}:</strong> <span id="motor-{{ i }}-current" class="badge bg-secondary">-- A</span>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <div class="col-md-6">
                                        {% for i in range(4, 8) %}
                                        <div class="motor-current-item mb-2">
                                            <strong>Motor {{ i }}:</strong> <span id="motor-{{ i }}-current" class="badge bg-secondary">-- A</span>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <strong>Total Current:</strong> <span id="motor-total-current" class="text-info">-- A</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Motor Controls (Robot Pi only, collapsed) -->
        {% if role == 'robot_pi' %}
        <div class="row mb-3">
            <div class="col-12">
                <div class="accordion" id="motorAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#motorBody">
                                Motor Test Controls
                            </button>
                        </h2>
                        <div id="motorBody" class="accordion-collapse collapse" data-bs-parent="#motorAccordion">
                            <div class="accordion-body">
                                <p class="text-muted small">Manual motor testing at 95% power (760/800). Motors disabled when E-STOP engaged.</p>
                                <div class="row">
                                    <div class="col-md-6">
                                        {% for i in range(4) %}
                                        <div class="motor-test-control mb-3">
                                            <strong>Motor {{ i }}</strong>
                                            <div class="btn-group ms-2" role="group">
                                                <button class="btn btn-sm btn-success" onclick="setMotor({{ i }}, 760)">Forward</button>
                                                <button class="btn btn-sm btn-secondary" onclick="setMotor({{ i }}, 0)">Stop</button>
                                                <button class="btn btn-sm btn-warning" onclick="setMotor({{ i }}, -760)">Backward</button>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <div class="col-md-6">
                                        {% for i in range(4, 8) %}
                                        <div class="motor-test-control mb-3">
                                            <strong>Motor {{ i }}</strong>
                                            <div class="btn-group ms-2" role="group">
                                                <button class="btn btn-sm btn-success" onclick="setMotor({{ i }}, 760)">Forward</button>
                                                <button class="btn btn-sm btn-secondary" onclick="setMotor({{ i }}, 0)">Stop</button>
                                                <button class="btn btn-sm btn-warning" onclick="setMotor({{ i }}, -760)">Backward</button>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="alert alert-warning mt-3" role="alert">
                                    <strong>Safety Notice:</strong> Ensure robot is in a safe testing position before activating motors.
                                    Use Emergency Stop button if needed.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Issues -->
        <div class="row">
            <div class="col-12">
                <div id="issues-container"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <!-- Pass role to JS -->
    <script>window.DASHBOARD_ROLE = '{{ role }}';</script>
    <script src="{{ url_for('static', filename='js/dashboard.js') }}?v={{ range(1, 9999999) | random }}"></script>
</body>
</html>
